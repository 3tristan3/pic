<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片处理工作台</title>
    
    <!-- 引入样式 -->
    <link rel="stylesheet" href="style.css">
    
    <!-- 第三方库：批量打包用 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- 第三方库：交互裁剪用 -->
    <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
</head>
<body>

<div class="container">
    <!-- === 深色模式切换按钮 === -->
    <button class="theme-toggle-btn" id="btn-theme-toggle">
        🌙 深色模式
    </button>

    <div class="header">
        <h1>图片处理工作台</h1>
        <div class="subtitle">Image Processing Workbench</div>
    </div>

    <!-- 导航栏 -->
    <div class="tabs">
        <button class="tab-btn active" data-target="tab-resize">📉 图片压缩</button>
        <button class="tab-btn" data-target="tab-convert">🔄 格式转换</button>
        <button class="tab-btn" data-target="tab-upscale">🔍 图片放大</button>
        <button class="tab-btn" data-target="tab-canvas">✂️ 图片裁剪</button>
        <button class="tab-btn" data-target="tab-stitch">🖼️ 长图拼接</button>
    </div>

    <div class="workspace">
        
        <!-- ================= 模块 1: 图片压缩 (弹窗管理模式) ================= -->
        <div id="tab-resize" class="tool-section active">
            <div class="control-row">
                <div class="input-group">
                    <label>1. 图片管理</label>
                    <!-- 点击触发弹窗 -->
                    <div class="fake-file-btn" id="btn-open-modal">
                        📂 管理图片库 (<span id="file-count-label">0</span>)
                    </div>
                </div>
                <div class="input-group">
                    <label>2. 目标大小 (KB)</label>
                    <input type="number" id="resize-target" value="100" min="10">
                </div>
                <div class="input-group" style="flex: 0;">
                    <label>&nbsp;</label>
                    <button class="action-btn" id="btn-run-resize">开始处理</button>
                </div>
            </div>
            <div style="font-size: 12px; color: var(--text-sub); text-align:center;">
                ℹ️ 说明：在弹窗中添加图片。若只有1张则生成预览；若多张则自动打包下载 ZIP。
            </div>
            
            <!-- 批量处理进度条 -->
            <div id="batch-progress" style="display:none; margin-top:15px; background:var(--bg-hover); border-radius:4px; padding:10px; text-align:center;">
                <span style="color:var(--primary); font-weight:bold; font-size:14px;">📦 正在批量处理: <span id="batch-count">0/0</span></span>
            </div>
        </div>

        <!-- 模块 2: 格式转换 -->
        <div id="tab-convert" class="tool-section">
            <div class="control-row">
                <div class="input-group">
                    <label>1. 选择图片</label>
                    <!-- 修改：增加了 file-wrapper 包裹和清除按钮 -->
                    <div class="file-wrapper">
                        <input type="file" id="convert-file" accept="image/*">
                        <div class="file-clear-btn" onclick="clearInput('convert-file')">×</div>
                    </div>
                </div>
                <div class="input-group">
                    <label>2. 目标格式</label>
                    <select id="convert-format">
                        <option value="image/jpeg" selected>JPG (通用)</option>
                        <option value="image/png">PNG (透明/无损)</option>
                        <option value="image/webp">WebP (小体积)</option>
                    </select>
                </div>
                <div class="input-group" style="flex: 0;">
                    <label>&nbsp;</label>
                    <button class="action-btn" id="btn-run-convert">开始转换</button>
                </div>
            </div>
            <div style="font-size: 12px; color: var(--text-sub); text-align:center;">
                ℹ️ 说明：保持原分辨率，仅转换文件格式。
            </div>
        </div>


        <!-- 模块 3: 图片放大 -->
        <div id="tab-upscale" class="tool-section">
            <div class="control-row">
                <div class="input-group">
                    <label>1. 选择图片</label>
                    <!-- 修改：增加了 file-wrapper 包裹和清除按钮 -->
                    <div class="file-wrapper">
                        <input type="file" id="upscale-file" accept="image/*">
                        <div class="file-clear-btn" onclick="clearInput('upscale-file')">×</div>
                    </div>
                </div>
                <div class="input-group">
                    <label>2. 放大倍数</label>
                    <select id="upscale-factor">
                        <option value="1.5">1.5x (轻微)</option>
                        <option value="2.0" selected>2.0x (双倍)</option>
                        <option value="3.0">3.0x (强力)</option>
                    </select>
                </div>
                <div class="input-group" style="flex: 0;">
                    <label>&nbsp;</label>
                    <button class="action-btn" id="btn-run-upscale">开始放大</button>
                </div>
            </div>
            <div style="font-size: 12px; color: var(--text-sub); text-align:center;">
                ℹ️ 说明：采用双三次插值算法，平滑放大图片细节。
            </div>
        </div>

        <!-- 模块 4: 图片裁剪 -->
        <div id="tab-canvas" class="tool-section">
            <div class="control-row crop-grid">
                <div class="input-group">
                    <label>1. 上传图片</label>
                    <!-- 修改：增加了 file-wrapper 包裹和清除按钮 -->
                    <div class="file-wrapper">
                        <input type="file" id="crop-file" accept="image/*">
                        <div class="file-clear-btn" onclick="clearInput('crop-file')">×</div>
                    </div>
                </div>
                <div class="input-group">
                    <label>2. 输出格式</label>
                    <select id="crop-format">
                        <option value="image/jpeg" selected>JPG</option>
                        <option value="image/png">PNG</option>
                        <option value="image/webp">WebP</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>3. 设定比例</label>
                    <div class="btn-group">
                        <button class="ratio-btn active" data-ratio="NaN">自由</button>
                        <button class="ratio-btn" data-ratio="1">1:1</button>
                        <button class="ratio-btn" data-ratio="1.7777">16:9</button>
                        <button class="ratio-btn" data-ratio="1.3333">4:3</button>
                    </div>
                </div>
                <div class="input-group">
                    <label>&nbsp;</label>
                    <button class="action-btn" id="btn-run-crop">✂️ 确认裁剪</button>
                </div>
            </div>
            
            <div id="crop-editor-container" style="display:none; margin-top: 20px;">
                <div style="height: 400px; background: var(--cropper-bg); border-radius: 8px; overflow: hidden; display:flex; justify-content:center; align-items:center;">
                    <img id="crop-image-source" style="max-width: 100%; display: block;">
                </div>
                <div style="font-size: 12px; color: var(--text-sub); margin-top: 8px; text-align: center;">
                    💡 提示：拖动白色边框调整大小，拖动中间移动选区，支持鼠标滚轮缩放。
                </div>
            </div>
        </div>
        <!-- ================= 模块 5: 长图拼接 (新增) ================= -->
        <div id="tab-stitch" class="tool-section">
            <div class="control-row">
                <div class="input-group">
                    <label>1. 选择多张图片</label>
                    <!-- 支持多选 -->
                    <div class="file-wrapper">
                        <input type="file" id="stitch-files" accept="image/*" multiple>
                        <div class="file-clear-btn" onclick="clearInput('stitch-files')">×</div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>2. 拼接模式</label>
                    <select id="stitch-mode">
                        <option value="vertical" selected>⬇️ 竖向拼接 (长图)</option>
                        <option value="horizontal">➡️ 横向拼接 (对比)</option>
                        <option value="grid">🪟 宫格拼接 (九宫格)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>3. 间距 / 边框</label>
                    <select id="stitch-gap">
                        <option value="0" selected>无间距</option>
                        <option value="10">小间距 (10px)</option>
                        <option value="20">大间距 (20px)</option>
                    </select>
                </div>
                
                <div class="input-group" style="flex: 0;">
                    <label>&nbsp;</label>
                    <button class="action-btn" id="btn-run-stitch">开始拼接</button>
                </div>
            </div>
            
            <div style="font-size: 12px; color: var(--text-sub); text-align:center;">
                ℹ️ 说明：支持拖拽排序。竖向模式下，图片将自动缩放至统一宽度以整齐排列。
            </div>

            <!-- 排序与预览区域 -->
            <div id="stitch-container" style="display:none; margin-top:20px;">
                <!-- 拖拽排序列表 -->
                <div class="stitch-sort-area" id="stitch-sort-list">
                    <!-- 缩略图会动态生成在这里 -->
                </div>
                <div style="text-align:center; margin:10px 0; color:#999; font-size:12px;">(可拖动图片调整顺序)</div>
            </div>
        </div>

        <!-- 公用 Loading -->
        <div id="loading" class="loading">⏳ 正在处理中...</div>

        <!-- 公用预览区 -->
        <div id="preview-area" class="preview-area" style="display: none;">
            <div class="preview-card" id="card-orig">
                <div class="stats" id="stats-orig"></div>
                <div class="img-box"><img id="img-orig" src=""></div>
                <div class="label-text">原始图片</div>
            </div>
            <div class="preview-card" id="card-res">
                <div class="stats" id="stats-res"></div>
                <div class="img-box success-border"><img id="img-res" src=""></div>
                <div class="label-text success-text">处理结果</div>
                <a id="btn-download" class="download-btn">⬇️ 下载文件</a>
            </div>
        </div>

    </div>
</div>

<!-- === 智能图片库弹窗 (Modal) === -->
<div class="modal-overlay" id="upload-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">图片批量管理</div>
            <div class="modal-close" id="btn-close-modal-x">×</div>
        </div>
        <div class="modal-body">
            <div class="upload-grid" id="thumb-grid">
                <!-- 添加按钮 -->
                <div class="upload-add-btn" id="btn-add-files">
                    <span style="font-size:24px;">+</span>
                    <span style="font-size:12px; margin-top:5px;">添加图片</span>
                </div>
                <!-- 缩略图动态插入 -->
            </div>
            <!-- 隐藏的真实 input -->
            <input type="file" id="real-file-input" accept="image/*" multiple style="display:none">
        </div>
        <div class="modal-footer">
            <!-- 清空按钮 -->
            <button class="ratio-btn" id="btn-clear-all" style="color:#ef4444; border-color:#ef4444; flex:0 0 auto;">🗑️ 清空全部</button>
            <div style="flex:1"></div>
            <button class="ratio-btn" id="btn-close-modal" style="flex:0 0 100px;">关闭</button>
            <button class="action-btn" id="btn-confirm-modal" style="width:auto; padding:0 30px;">确认并返回</button>
        </div>
    </div>
</div>

<!-- 引入主逻辑 -->
<script type="module" src="./js/main.js"></script>
</body>
</html>
